<% prevuserid = nil %>
<% lastmessageid= nil %>
<% firstmessageid= nil %>
<% messagecount = 0 %>
<% conversation.receipts_for(current_user).order("id DESC").first(20).each do |receipt| %>
  <%
    message = receipt.message
    userid = message.sender.id
    firstmessageid = receipt.id if firstmessageid.nil? || receipt.id < firstmessageid
    messagecount = messagecount + 1
  %>
<div class="col-md-3">
  <b><%= message.sender.profile.first_name %>
        <% if message.created_at < (Time.now - 1.day) %>
          <span style="font-size:50%;">(<%=message.created_at.strftime("%m/%d")%>)</span>
        <% else %>
          <span style="font-size:50%;">(<%=message.created_at.strftime("%l:%M %P")%>)</span>
        <% end %>
  :</b>
</div>
<div class="col-md-9">
  <p>
  <% unless message.is_read?(current_user) %><b><% end %>
    <%= message.body %>
  <% unless message.is_read?(current_user) %></b><% end %>
  </p>
</div>
  <%
    if lastmessageid.nil? || (receipt.id > lastmessageid)
      prevuserid = message.sender.id
      lastmessageid = receipt.id
    end
    message.mark_as_read(current_user)
  %>
<% end %>

<script>
  $('#first_id_shown').val(<%=firstmessageid%>)
  $('#last_id_shown').val(<%=lastmessageid%>)
  $('#last_user_shown').val(<%=prevuserid%>)
  <% if messagecount < 20 %> $('#earlier_messages').html('No More Messages To Load') <% end %>
</script>
